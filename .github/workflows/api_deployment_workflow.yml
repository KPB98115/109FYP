name: Rest API integration check and deployment

on:
  push:
    branches: [ "main" ]

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          path: rest_api

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.10.2'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-dev python3-pip

      - name: Clone Yolov5
        uses: sudosubin/git-clone-action@8a93ce24d47782e30077508cccacf8a05a891bae
        with:
          # Repository owner and name. Ex: sudosubin/git-clone-action
          repository: KPB98115/109FYP
          # Git host platform. Ex: github, gitlab, bitbucket, gitee, or else (git.suckless.org, ...)
          platform: github
          # Git branch or tag to checkout.
          ref: main
          # Relative path from current directory, where to clone.
          path: https://github.com/ultralytics/yolov5.git

      - name: Install face_recognition
        run: |
          git clone -b 'v19.9' --single-branch https://github.com/davisking/dlib.git dlib/
          cd dlib
          python3 setup.py install --yes USE_AVX_INSTRUCTIONS
        
      - name: Install other Python packages from requirements.txt
        run: pip install -r requirements.txt

      - name: Build Docker image
        run: docker build -t kbp98115/api_109fyp:latest .

      - name: Log in to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Push Docker image
        run: docker push kbp98115/api_109fyp:latest
        
      - name: Deploy Docker container
        run: |
          docker stop test || true
          docker rm test || true
          docker run -d --name test -p 80:80 kbp98115/api_109fyp:latest

      - name: Run test.py script
        run: python test.py image/ghAction_test.jpg kbp98115/api_109fyp:latest
